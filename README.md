# webservice
Простой веб-сервис, который при GET запросе отображает картинку.</br>
При запуске сервис считывает конфигурационный файл и начинает слушать HTTP обращения.</br>
Пример заполнения конфигурационного файла:
```
https://tululu.org/images/001/001.png;500;flight
https://tululu.org/images/001/002.png;3300;show;britain;bennyhill;sketches;tv
https://tululu.org/images/001/003.png;1500;games;minecraft;blocks;sandbox
https://tululu.org/images/001/004.png;520;onlycategory;games
https://tululu.org/images/001/005.png;150;flight;show;airlplane
https://tululu.org/images/001/006.png;2300;show;britain;bennyhill;sketches
https://tululu.org/images/001/007.png;150;games
https://tululu.org/images/001/008.png;120;onlycategory
```
Клиент HTTP GET запросом сообщает категории, которые он готов принять, к примеру:
```
http://127.0.0.1:8000/?category[]=show&category[]=games
``` 
В ответ на него сервис выдает простую HTML обертку с изображением картинки, которая совпадает минимум по одной категории.
Картинки отображаются произвольно если в запросе категорий не указано. 
Каждый показ вычитается из количества необходимых к показу.<br>

Для реализации механизма, позволяющего минимизировать вероятность возникновения случаев, когда подходящие картинки уже исчерпали свой лимит и ответить на запрос нечем, высчитывается количество показов картинки в пересчете на одну категорию.</br>
В первую очередь выдаются картинки с максимальными количеством показов на категорию.</br>

Механизм, который уменьшает вероятность выдачи одной и той же картинки несколько раз подряд реализован за счет выбора случайным образом картинки из нескольких картинок с максимальным показом.


## Переменные виртуального окружения

Создайте файл `.env` в каталоге с проектом, если используете docker, или в каталоге app, если используете виртуальное окружение, со следующими настройками:

- `DEBUG` — дебаг-режим. Поставьте `False`.
- `SECRET_KEY` — секретный ключ проекта. Он отвечает за шифрование на сайте.
- `ALLOWED_HOSTS` — белый список имен хостов / доменов, на которых может обслуживаться ваш веб-сервер.
-  `IS_POSTGRESQL` - `True`, если будет использоваться ***postgresql*** и `False` если ***sqlite***</br>
В случае использования ***postgresql*** потребуются дополнительные переменные окружения:
- `DATABASE_URL`— параметры подключения к базе данных в url формате (например `postgres://pguser:pgpasswd2024@dbase/pgdb`).
- `POSTGRES_DB` — имя базы данных (например `pgdb`).
- `POSTGRES_USER` — пользователь базы данных (например `pguser`).
- `POSTGRES_PASSWORD` — пароль к базе данных (например `pgpasswd2024`).
В реальном проекте лучше использовать более сложные пароли.

## Запуск в докере

Для запуска сервиса в ***docker*** используются ***Nginx*** и ***Posqresql***</br>
Зайдите в терминале в каталог с проектом (каталог ***webservice***), файл `.env` должен быть заполнен в том числе и параметрами для ***Posqresql***, и выполните следующую команду:
```bash
docker compose up -d
```
Возможный результат выполнения команды:</br>
![Снимок экрана_2024-05-19_22-48-44](https://github.com/Amartyanov1974/webservice/assets/74543172/11283494-b733-4353-a0dd-05a20edcedd6)</br>
Сервис будет доступен по адресу, указанному в переменной ALLOWED_HOSTS.

## Запуск локально в виртуальном окружении

Для запуска необходимо проделать следующую последовательность действий:
-  создать виртуальное окружение (на локальном компьютере я предпочитаю использовать [***conda***](https://www.anaconda.com/download)) (если используете другие инструменты, например `python -m venv 'имя_вирт_окружения`, виртуальное окружение необходимо создавать в каталоге с проектом);
-  активировать его:</br>
![Снимок экрана_2024-05-19_23-14-42](https://github.com/Amartyanov1974/webservice/assets/74543172/f91f23ff-c6c8-4801-89f4-ff609617ad4f)
-  в этом виртуальном окружении установить необходимые библиотеки:
```bash
pip install -r requirements.txt
```
-  синхронизировать базу данных с текущими моделями и существующими миграциями, для чего в каталоге с проектом (каталоге ***app***) выполнить следующую команду:
```bash
python3 manage.py mirgate
```
-  далее запускаем сервис в директории с проектом следующей командой:
```bash
python3 manage.py runserver
```
Сервис будет доступен по адресу [http://127.0.0.1:8000](http://127.0.0.1:8000)
### Дополнения
Для разработки использовалась версия python3.10</br>
Если у вас под рукой нет рабочего Posqresql сервера, в .env в параметре IS_POSTGRESQL должно быть False.

## Цель работы
Выполнение тестового задания
